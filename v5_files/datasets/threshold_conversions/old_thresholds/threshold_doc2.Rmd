---
title: "New Dry Weight and Threshold conversions"
output: 
  html_document:
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(purrr)
library(sf)
library(dplyr)
library(ggplot2)
library(data.table)
```

# Data Preparation

We'll start by working with the raw azmp data and the vertically corrected ecomon dataset. 

```{r}
root <- "/mnt/ecocast/projectdata/calanusclimate/src"

azmp <- azmpcfin::read_calanus()
e_corr <- readr::read_csv(file.path(root, "vertical_correction_ecomon.csv.gz"),
                          col_types = readr::cols())
```

To support the dry weight and threshold conversions, we must assign each point to a region. 

All ecomon points are in the region "gom". 

```{r}
e_corr <- mutate(e_corr, 
                 region_tc = "gom")
```

AZMP regions are defined based on transect and station, using the methods provided by Caroline. 

```{r}
# computing region_vd
get_region_vd <- function(transect, station) {
  if (is.na(transect)) {
    "gom"
  } else if (transect == "BBL") {
    "wss"
  } else if (transect %in% c("HL", "LL", "SESPB", "SWSPB") || 
             station == "HL2") {
    "ess"
  } else if (station == "P5") {
    "gom"
  } else {
    "gsl"
  }
}

azmp <- azmp |>
  mutate(region_tc = purrr::map2(transect, station, get_region_vd) |>
           unlist())
```
```{r, echo = FALSE}
regions <- read_sf(dsn = "shapefiles/Regions_dw_vd_poly_all.shp") |>
  st_make_valid() |>
  st_transform(crs = 4326)

ggplot() +
  geom_sf(data = regions, alpha = 0, col = "black") +
  geom_polygon(data = ggplot2::map_data("world"), 
               aes(long, lat, group = group),
               fill = "lightgray", col = "gray") +
  geom_point(data = azmp, aes(x = longitude, y = latitude, col = region_tc), alpha = .7) +
  coord_sf(xlim = c(-70, -40), ylim = c(40, 60), expand = TRUE) +
  theme_bw() + 
  ggtitle("AZMP points by threshold conversion region")
```

Then, we bind the two datasets together and merge it with Brickman datapoints.

```{r, eval = FALSE, include = FALSE}
desired_vars <- c("src", "id", "date", "region_tc",
                  "longitude", "latitude", "abundance")

e_corr <- e_corr |>
  mutate(src = "ecomon", 
         station = NA,
         transect = NA,
         id = sprintf("%s_%i", .data$cruise_name, .data$station)) |>
  rename(abundance = corrected_CIV_CVI_m2, depth = sta_depth) |>
  select(all_of(desired_vars))

azmp <- azmp |>
  mutate(src = "azmp", 
         id = sprintf("%s_%s", .data$transect, .data$station),
         date = as.Date(sprintf("%0.4i-%0.2i-%0.2i", .data$year, .data$month,.data$day)),
         abundance = (.data$calanus_finmarchicus_iv + 
                        .data$calanus_finmarchicus_v + 
                        .data$calanus_finmarchicus_vi)) |>
  select(all_of(desired_vars))
    
ae <- bind_rows(azmp, e_corr) |>
  mutate(month = as.numeric(format(date, "%m"))) |>
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
```
```{r, eval = FALSE, include = FALSE}
brickman_source <- brickman::compose_filename("PRESENT")

brickman_vars <- brickman::query_layers(scenario = "PRESENT")
brickman_vars <- brickman_vars[!grepl("_ann", brickman_vars)]

data <- brickman::extract_points(brickman_source, 
                                 brickman_vars, 
                                 ae, 
                                 complete = TRUE,
                                 simplify_names = FALSE) |> 
  bind_cols(ae) |>
  select(-nav_lat, -nav_lon, -olon, -olat, -index, -row, -col, -geometry) |>
  rowwise() |>
  mutate_at(c("Xbtm", "MLD", "Sbtm", "SSS", "SST", "Tbtm", "U", "V"), 
            ~.x[[month]]) |>
  ungroup()

# saving to file 
readr::write_csv(data(), file = file.path(root, "tc_datasets/ae_regionvd_cfin.csv.gz"))
```

```{r}
ae <- readr::read_csv(file.path(root, "tc_datasets/ae_regionvd_cfin.csv.gz"),
                      col_types = readr::cols())

head(ae)
```
```{r, echo = FALSE}
ggplot(ae, aes(x = log10(abundance + 1))) +
  geom_histogram(bins = 50, col = "white", fill = "yellowgreen") +
  ggtitle("Abundance count distribution") + 
  theme_bw()
```

<br>

# Dry Weight Conversion

I'm using averaged IDW estimates pulled from Sorochan et. al 2019.

* I'm ignoring the southwest GSL estimates pulled from Plourde et. al. 2019 and instead choosing to focus on the top four rows. 
* I'm using C5 to approximate averaged C4-C6 IDW. 

![Sorochan et. al 2019, Table 2](sorochan_table.jpeg)

```{r}
ae_dw <- ae |>
  mutate(dry_weight = abundance * 
           map(region_tc, ~ifelse(.x == "gsl", 333, 195)) |> unlist())
```

```{r, echo = FALSE}
ggplot(ae_dw, aes(x = log10(dry_weight + 1))) +
  geom_histogram(bins = 50, col = "white", fill = "yellowgreen") +
  ggtitle("Dry Weight biomass distribution") + 
  theme_bw()
```
```{r, echo = FALSE}
ae_dw |> 
  mutate(across(month, as.factor)) |>
  group_by(month, region_tc) |>
  summarize(n()) |>
  ggplot(aes(x = month, y = region_tc, fill = log10(`n()` + 1))) +
  geom_raster() +
  theme_bw() +
  ggtitle("Number of points for each region and month") +
  viridis::scale_fill_viridis()
```

# Threshold Conversion

Next, we convert from dry weight to threshold. Threshold is computed based off of region and bathymetry. We use the lookup table provided by caroline to determine the biomass threshold at a given point. 

Some months performed badly in analyses, and so we map predictions to adjacent months instead. 
```{r}
month_map <- matrix(c(
  11, 11, 4, 4, 6, 6, 6, 9, 9, 10, 11, 11,
  11, 11, 4, 4, 5, 6, 6, 9, 9, 10, 11, 11, 
  11, 11, 3, 5, 5, 6, 7, 8, 9, 11, 11, 11,
  1, 1, 4, 4, 4, 7, 7, 8, 8, 12, 12, 12), 
  nrow = 12,
  dimnames = list(c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12), c("ess", "wss", "gsl", "gom"))
)

ae_thresholds <- ae_dw |>
  rowwise() |>
  mutate(tmonth = month_map[[month, region_tc]]) |>
  ungroup()
```

```{r}
thresholds <- read.table("Calanus_threshold.txt", header = TRUE) |>
  group_by(month, region_vd)

tkeys <- group_keys(thresholds)
tlist <- group_split(thresholds, .keep = FALSE) |>
  map(~as.data.table(.x) |> 
        setkey(depth))
names(tlist) <- paste(tkeys$region_vd, tkeys$month)

ae_thresholds <- ae_thresholds |> 
  group_by(tmonth, region_tc) |>
  group_split() |>
  lapply(function(a) tlist[[paste(a[[1, "region_tc"]], a[[1, "month"]])]]
         [J(a$Bathy_depth), roll = "nearest"] |>
           select(Min_cfin_mgm2) |>
           bind_cols(a)) |>
  bind_rows() |>
  mutate(patch = dry_weight >= 1000 * Min_cfin_mgm2)

count(ae_thresholds, patch) |>
  mutate(percent = n/sum(n))
```
```{r, echo = FALSE} 
# threshold map
ggplot(ae_thresholds, aes(x = lon, y = lat)) +
  geom_polygon(data = ggplot2::map_data("world"), 
               aes(long, lat, group = group),
               fill = "lightgray", col = "gray") +
  geom_point(aes(col = log10(Min_cfin_mgm2 + 1)), alpha = .3) +
  coord_quickmap(xlim = c(-76, -40), ylim = c(35, 60), expand = TRUE) +
  viridis::scale_color_viridis() +
  theme_bw() + 
  ggtitle("Threshold values")

# patch map
ggplot(ae_thresholds, aes(x = lon, y = lat)) +
  geom_polygon(data = ggplot2::map_data("world"), 
               aes(long, lat, group = group),
               fill = "lightgray", col = "gray") +
  geom_point(aes(col = patch), alpha = .7) +
  coord_quickmap(xlim = c(-76, -40), ylim = c(35, 60), expand = TRUE) +
  theme_bw() + 
  ggtitle("Patch values")

ggplot(filter(ae_thresholds, patch), aes(x = lon, y = lat)) +
  geom_polygon(data = ggplot2::map_data("world"), 
               aes(long, lat, group = group),
               fill = "lightgray", col = "gray") +
  geom_point(col = "blue", alpha = .7) +
  coord_quickmap(xlim = c(-76, -40), ylim = c(35, 60), expand = TRUE) +
  theme_bw() + 
  ggtitle("Positive patch values")
```

